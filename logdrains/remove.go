package logdrains

import (
	"context"

	"gopkg.in/errgo.v1"

	"github.com/Scalingo/cli/config"
	"github.com/Scalingo/cli/io"
	"github.com/Scalingo/go-utils/errors/v2"
)

type RemoveAddonOpts struct {
	AddonID string
	OnlyApp bool
	URL     string
}

func Remove(ctx context.Context, app, database string, opts RemoveAddonOpts) error {
	c, err := config.ScalingoClient(ctx)
	if err != nil {
		return errgo.Notef(err, "fail to get Scalingo client to remove a log drain from the application")
	}

	if database != "" {
		err := c.LogDrainAddonRemove(ctx, app, database, opts.URL)
		if err != nil {
			return errors.Wrapf(ctx, err, "remove the log drain from the database %s", database)
		}
		io.Status("The log drain", opts.URL, "has been deleted from the database", database)
		return nil
	}

	if opts.AddonID != "" {
		// addon only
		err := c.LogDrainAddonRemove(ctx, app, opts.AddonID, opts.URL)
		if err != nil {
			return errgo.Notef(err, "fail to remove the log drain from the addon %s", opts.AddonID)
		}
		io.Status("The log drain", opts.URL, "has been deleted from the addon", opts.AddonID)
		return nil
	}

	err = c.LogDrainRemove(ctx, app, opts.URL)
	if err != nil {
		io.Status("fail to remove the log drain from the application:", app, "\n\t", err)
	} else {
		io.Status("Log drain", opts.URL, "has been deleted from the application", app)
	}

	if !opts.OnlyApp {
		addons, err := c.AddonsList(ctx, app)
		if err != nil {
			return errgo.Notef(err, "fail to list addons to remove log drain")
		}

		for _, addon := range addons {
			err := c.LogDrainAddonRemove(ctx, app, addon.ID, opts.URL)
			if err != nil {
				io.Status("fail to remove the log drain from the addon:", addon.AddonProvider.Name, "\n\t", err)
			} else {
				io.Status("Log drain", opts.URL, "has been deleted from the addon", addon.AddonProvider.Name)
			}
		}
	}

	return nil
}
